package mp4_test

import (
	"bytes"
	"os"
	"testing"

	"github.com/Eyevinn/mp4ff/bits"
	"github.com/Eyevinn/mp4ff/mp4"
)

// Test decode + encode file with slice reader and writer
func TestDecodeEncodeSRW(t *testing.T) {
	testFiles := []string{
		"testdata/1.m4s",
		"testdata/prog_8s_enc_dashinit.mp4",
		"testdata/prog_8s.mp4",
	}
	for _, testFile := range testFiles {

		inData, err := os.ReadFile(testFile)
		if err != nil {
			t.Error(err)
		}
		sr := bits.NewFixedSliceReader(inData)
		decFile, err := mp4.DecodeFileSR(sr)
		if err != nil {
			t.Error(err)
		}
		decFile.FragEncMode = mp4.EncModeBoxTree
		sw := bits.NewFixedSliceWriter(len(inData))
		err = decFile.EncodeSW(sw)
		if err != nil {
			t.Error(err)
		}
		if !bytes.Equal(inData, sw.Bytes()) {
			t.Errorf("mismatch for testfile %s. Generated bytes differ from input", testFile)
		}
	}
}
